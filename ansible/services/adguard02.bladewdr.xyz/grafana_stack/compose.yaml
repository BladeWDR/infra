services:
  loki:
    container_name: loki
    image: docker.io/grafana/loki:3.5.1@sha256:a74594532eec4cc313401beedc4dd2708c43674c032084b1aeb87c14a5be1745
    command: "-config.file=/etc/loki/config.yaml"
    ports:
      - "3100:3100"
    volumes:
      - /apps/grafana-stack/loki/config.yaml:/etc/loki/config.yaml:ro
      - /mnt/logdata/logs:/loki:rw
    restart: unless-stopped
  grafana:
    image: docker.io/grafana/grafana-oss:12.0.2@sha256:b5b59bfc7561634c2d7b136c4543d702ebcc94a3da477f21ff26f89ffd4214fa
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      - /apps/grafana-stack/grafana-data:/var/lib/grafana
    environment:
      - GF_SERVER_ROOT_URL={{ grafana_root_url }}
      - GF_SMTP_ENABLED=true
      - GF_SMTP_HOST={{ SMTP_SERVER_ADDRESS }}:{{ SMTP_PORT }}
      - GF_SMTP_USER={{ SMTP_USERNAME }}
      - GF_SMTP_PASSWORD={{ SMTP_PASSWORD }}
      - GF_SMTP_FROM_ADDRESS={{ SMTP_FROM }}
      - GF_SMTP_FROM_NAME=Grafana Notifications
    restart: unless-stopped
  prometheus:
      image: prom/prometheus:v3.8.1@sha256:2b6f734e372c1b4717008f7d0a0152316aedd4d13ae17ef1e3268dbfaf68041b
      container_name: prometheus
      restart: unless-stopped
      extra_hosts:
        - "host.docker.internal:host-gateway"
      user: "1000:1000"
      ports:
        - 9090:9090/tcp
      environment:
        - TZ={{ host_timezone }}
      security_opt:
        - no-new-privileges:true
      volumes:
        - /apps/grafana-stack/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
        - /apps/grafana-stack/prometheus/data:/prometheus
      command:
        - --config.file=/etc/prometheus/prometheus.yml
        - --storage.tsdb.path=/prometheus
        - --storage.tsdb.retention.time=30d
        - --web.enable-lifecycle
        - --web.enable-admin-api
