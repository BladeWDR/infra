services:
  web:
    image: ghcr.io/karakeep-app/karakeep:release@sha256:2724d4a9a6d13a7fa3babf53b9245767aae56c34f06042a8463ee983c6b41caf
    container_name: hoarder-web
    networks:
      - proxy
    restart: unless-stopped
    volumes:
      - ./karakeep/data:/data
    environment:
      - DATA_DIR=/data
      - HOARDER_VERSION=release
      - NEXTAUTH_SECRET={{ KARAKEEP_NEXTAUTH_SECRET }}
      - MEILI_MASTER_KEY={{ KARAKEEP_MEILI_MASTER_KEY }}
      - NEXTAUTH_URL=https://{{ KARAKEEP_HOST }}
      - DISABLE_SIGNUPS=true
      - OAUTH_CLIENT_SECRET={{ KARAKEEP_OAUTH_CLIENT_SECRET }}
      - OAUTH_CLIENT_ID={{ KARAKEEP_OAUTH_CLIENT_ID }}
      - OAUTH_WELLKNOWN_URL=https://{{ AUTHENTIK_HOST }}/application/o/hoarder/.well-known/openid-configuration
      - OAUTH_PROVIDER_NAME=Authentik
      - OAUTH_SCOPE=openid email profile
      - MEILI_NO_ANALYTICS=true
      - MEILI_ADDR=http://hoarder-meilisearch:7700
      - BROWSER_WEB_URL=http://hoarder-chrome:9222
      - OLLAMA_BASE_URL=https://ollama.{{ TRAEFIK_HOST_DOMAIN }}
      - INFERENCE_TEXT_MODEL=llama3.2:8b
      - INFERENCE_IMAGE_MODEL=llama3.2:8b
      - INFERENCE_JOB_TIMEOUT_SEC=60
      - EMBEDDING_TEXT_MODEL=llama3.2:8b
    labels:
      - traefik.enable=true
      - traefik.http.routers.hoarder.entrypoints=https
      - traefik.http.routers.hoarder.rule=Host(`{{ KARAKEEP_HOST }}`)
      - traefik.http.services.hoarder.loadbalancer.server.port=3000
      - traefik.http.routers.hoarder.middlewares=default-headers@file
      - traefik.http.routers.hoarder.tls=true
  chrome:
    image: gcr.io/zenika-hub/alpine-chrome:124@sha256:1a0046448e0bb6c275c88f86e01faf0de62b02ec8572901256ada0a8c08be23f
    restart: unless-stopped
    container_name: hoarder-chrome
    networks:
      - proxy
    command:
      - --no-sandbox
      - --disable-gpu
      - --disable-dev-shm-usage
      - --remote-debugging-address=0.0.0.0
      - --remote-debugging-port=9222
      - --hide-scrollbars
  meilisearch:
    container_name: hoarder-meilisearch
    networks:
      - proxy
    environment:
      - MEILI_NO_ANALYTICS=true
      - MEILI_ADDR=http://hoarder-meilisearch:7700
      - MEILI_MASTER_KEY={{ KARAKEEP_MEILI_MASTER_KEY }}
    image: getmeili/meilisearch:v1.35.0@sha256:348ba1c1f61101130304370a9522cc5405e6906b64a426dc2fcd5c428a516a98
    restart: unless-stopped
    volumes:
      - ./karakeep/meilisearch:/meili_data

networks:
  proxy:
    external: true
